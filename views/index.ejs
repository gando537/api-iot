<!DOCTYPE html>
<html>
<head>
    <%- include('parts/head') %> 
</head>
<body>
    <%- include('parts/navbar') %>

    <div id="status" class="mt-3 mb-4">
        <div class="d-flex flex-row align-items-center">
          <i class="bi bi-box-arrow-in-left me-2"></i>
          <h3 class="mb-0 text-left">All accesses</h3>
        </div>
        <table id="all-data-table">
            <thead>
                <tr>
                <th>Pool</th>
                <th>Client</th>
                <th>Date</th>
                <th>Request</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data rows will be dynamically inserted here -->
            </tbody>
        </table>
      </div>
    </div>

    <div class="container" style="margin-top:100px; margin-bottom:100px;">
        <div class="row">
            <div class="d-flex flex-row align-items-center">
                <i class="bi bi-water me-2"></i>
                <h3 class="mb-0 text-left">Pools list</h3>
              </div>
            <div id="left-side" class="col-lg-6 col-12 order-lg-1 order-2">
                <table class="table" id="pool-data-table">
                    <thead>
                        <tr>
                        <th>Pool</th>
                        <th>Temperature</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <div id="right-side" class="col-lg-6 col-12 order-lg-2 d-flex align-items-top justify-content-center">
                <div id="map"></div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="d-flex flex-row align-items-center">
                <i class="bi bi-people me-2"></i>
                <h3 class="mb-0 text-left">Users list</h3>
              </div>
            <div id="left-side" class="col-lg-6 col-12 order-lg-1 order-2">
                <table class="table" id="user-data-table">
                    <thead>
                        <tr>
                        <th>User</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        
            <div id="right-side" class="col-lg-6 col-12 order-lg-2 d-flex align-items-top justify-content-center">
                <div id="user_map"></div>
            </div>
        </div>
    <%- include('parts/script') %>
    <script>
        $.fn.dataTable.ext.errMode = 'none';
    </script>
    <script>
        // Initialize the map
        let map = L.map('map').setView([43.6030664749555, 7.083116986918272], 8);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        map.setZoom(8);

        let mapUser = L.map('user_map').setView([43.6030664749555, 7.083116986918272], 8);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(mapUser);
        mapUser.setZoom(8);

        let marker;
        
        // Retrieve data from the server
        fetch('/get')
        .then(response => response.json())
        .then(data => {
            // Initialize DataTable with the data
            try {    
                const dataTable = new DataTable('#all-data-table', {
                data: data,
                columns: [
                    { data: 'pool' },
                    { data: 'client' },
                    { data: 'date' },
                    { data: 'request' }
                ]
                });
            } catch (error) {
                throw error;
            }
        })
        .catch(error => console.error(error));

        fetch('/pools')
        .then(response => response.json())
        .then(data => {
            // Initialize DataTable with the data
            try {  
                const dataTable = new DataTable('#pool-data-table', {
                    data: data,
                    columns: [
                        { data: 'ident' },
                        { data: 'temperature' },
                    ],
                    searching: false,
                    lengthChange: false,  
            }   );
            } catch (error) {
                throw error;
            }
            const urlParams = new URLSearchParams(window.location.search);
            const idClient = urlParams.get('idEtudiant');
            data.forEach(pool => {
                console.log(pool.color);
                if ( pool.color == "Grey" || pool.color == "Brown") {
                    let customIcon = {
                        iconUrl:"https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|abcdef&chf=a,s,ee00FFFF",
                        iconSize:[40,40]
                    }
                    let myIcon = L.icon(customIcon);
                    let iconOptions = {
                        icon: myIcon
                    }
                    marker = L.marker([pool.lat, pool.lon], iconOptions).addTo(map);
                } else if ( pool.color == "Green") {
                    let customIcon = {
                        iconUrl:"https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|2ecc71&chf=a,s,ee00FFFF",
                        iconSize:[40,40]
                    }
                    let myIcon = L.icon(customIcon);
                    let iconOptions = {
                        icon: myIcon
                    }
                    marker = L.marker([pool.lat, pool.lon], iconOptions).addTo(map);
                } else if ( pool.color == "Red") {
                    let customIcon = {
                        iconUrl:"https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|e85141&chf=a,s,ee00FFFF",
                        iconSize:[40,40]
                    }
                    let myIcon = L.icon(customIcon);
                    let iconOptions = {
                        icon: myIcon
                    }
                    marker = L.marker([pool.lat, pool.lon], iconOptions).addTo(map);
                } else {
                    marker = L.marker([pool.lat, pool.lon]).addTo(map);
                }
                //pool.ident.replace("_", "")
                marker.bindPopup("<b>"+pool.ident+"</b><br>water temperature: "+pool.temperature+"Â°C" + "<br> openDoor: <a href='/open?espIdent=" + pool.ident + "&idEtudiant=" + idClient + "' target='_blank'>Ouvrir</a>").closePopup();
            });
        })
        .catch(error => console.error(error));

        fetch('/users')
        .then(response => response.json())
        .then(data => {
            // Initialize DataTable with the data
            try {
                const dataTable = new DataTable('#user-data-table', {
                    data: data,
                    columns: [
                        { data: 'tid' },
                        { data: 'lat' },
                        { data: 'lon' },
                    ],
                    searching: false,
                    lengthChange: false,  
                });

                data.forEach(user => {
                    marker = L.marker([user.lat, user.lon]).addTo(mapUser);
                    marker.bindPopup("<b>"+user.tid+"</b><br>position: ["+user.lon+", "+user.lon+"]").closePopup();
                });
            } catch (error) {
                throw error;
            }
        })
        .catch(error => console.error(error));
    </script>
</body>
</html>
